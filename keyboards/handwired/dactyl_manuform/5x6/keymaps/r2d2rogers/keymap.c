
#include QMK_KEYBOARD_H
#include "r2d2rogers.h"

#include "dactyl_manuform.h"
#include "action_layer.h"
#include "eeconfig.h"
#include "report.h"
#include "pointing_device.h"

extern keymap_config_t keymap_config;

#define LONGPRESS_COUNT 4

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

  [_QWERTY] = LAYOUT(
// ,-----------------------------------------------------.   ------------------------------------------------------.
     KC_GRV , ________________NUMBER_LEFT________________,     ________________NUMBER_RIGHT_______________, KC_MINS,
// |--------+--------+--------+--------+--------+--------|   +--------+--------+--------+--------+--------+--------|
     KC_TAB , _________________QWERTY_L1_________________,     _________________QWERTY_R1_________________, KC_BSLS,
// |--------+--------+--------+--------+--------+--------|   +--------+--------+--------+--------+--------+--------|
     KC_ESCC, _________________QWERTY_L2_________________,     _________________QWERTY_R2_________________, KC_QUOT,
// |--------+--------+--------+--------+--------+--------|   +--------+--------+--------+--------+--------+--------|
     KC_LSFT, _________________QWERTY_L3_________________,     _________________QWERTY_R3_________________, KC_RSFT,
// '-----------------+--------+--------+-----------------'   +-----------------+--------+--------+-----------------'
                       KC_LALT, KC_LGUI,                                         KC_RGUI, KC_RALT,
//                   '-----------------'                                       '-----------------'
//                                     .-----------------.   .-----------------.
                                         LOWER  , SPACEFN,     SPACEFN, RAISE  ,
//                                     |--------+--------|   |--------+--------|
                                         RAISE  , KC_BSPC,     KC_ENT , LOWER  ,
//                                     |--------+--------|   |--------+--------|
                                         ADJUST , SPACEFN,     SPACEFN, ADJUST ,
//                                     '-----------------'   '-----------------'
  ),

/* Lower
 * ,------------------------------------------------   ------------------------------------------------.
 * |   ~   |   !   |   @   |   #   |   $   |   %   |   |   ^   |   &   |   *   |   (   |   )   | Bksp  |
 * |-------+-------+-------+-------+-------+--------   +-------+-------+-------+-------+-------+-------|
 * |   ~   |   !   |   @   |   #   |   $   |   %   |   |   ^   |   &   |   *   |   (   |   )   | Del   |
 * |-------+-------+-------+-------+-------+--------   +-------+-------+-------+-------+-------+-------|
 * | Del   |  F1   |  F2   |  F3   |  F4   |  F5   |   |  F6   |   _   |   +   |     |     \   |  |    |
 * |-------+-------+-------+-------+-------+-------|   +-------+-------+-------+-------+-------+-------|
 * |       |  F7   |  F8   |  F9   |  F10  |  F11  |   |  F12  |ISO ~  |ISO |  |       |       |Enter  |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 *                 |       |       |                                   |       |       |
 *                 `-------+-------'                                   `-------+-------'
 *                 +-------+-------+-------+-------+   +-------+-------+-------+-------+
 *                 |       |       |       |       |   |       |       |       |       |
 *                 `-------+-------+-------+-------+   +-------+-------+-------+-------'
 *                                 |       |       |   |       |       |
 *                                 `----------------   ----------------'
 */





  [_LOWER] = LAYOUT(
    KC_ESC, _________________FUNC_LEFT_________________,    _________________FUNC_RIGHT________________, KC_BSPC,
    KC_TILD,_________________LOWER_L1__________________,    _________________LOWER_R1__________________,KC_DEL,
    KC_DEL, _________________LOWER_L3__________________,    _________________LOWER_R2__________________,KC_PIPE,
    _______,_________________LOWER_L3__________________,    _________________LOWER_R3__________________,_______,
    _______,KC_F7,  KC_F8,  KC_F9,  _______,_______,    _______,_______,_______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,    _______,_______,_______,_______,_______,_______
  ),

/* Raise
 * ,------------------------------------------------------   ------------------------------------------------------.
 * |--------+--------+--------+--------+--------+---------   +--------+--------+--------+--------+--------+--------|
 * |--------+--------+--------+--------+--------+---------   +--------+--------+--------+--------+--------+--------|
 * |--------+--------+--------+--------+--------+--------|   +--------+--------+--------+--------+--------+--------|
 * '--------+--------+--------+--------+--------+--------+   +--------+--------+--------+--------+--------+--------'
 *                   '--------+--------'                                       '--------+--------'
 *                   +--------+--------+--------+--------+   +--------+--------+--------+--------+
 *                   '--------+--------+--------+--------+   +--------+--------+--------+--------'
 *                                     '-----------------'   '-----------------'
 */
  [_RAISE] = LAYOUT(
    KC_ESC, _________________FUNC2_LEFT________________, _________________FUNC2_RIGHT_______________, KC_BSPC,
    KC_GRV, _________________RAISE_L1__________________,    _________________RAISE_R1__________________, KC_DEL,
    KC_DEL, _________________RAISE_L3__________________,    _________________RAISE_R2__________________,KC_BSLS,
    _______,_________________RAISE_L3__________________,    _________________RAISE_R3__________________,_______,
    _______,KC_F7,  KC_F8,  KC_F9,  _______,_______,    _______,_______,KC_NUBS,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,    _______,_______,_______,_______,_______,_______
  ),

/* Space Function
 * ,------------------------------------------------   ------------------------------------------------.
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * `-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 *                 |       |       |                                   |       |       |
 *                 `-------+-------'                                   `-------+-------'
 *                 +-------+-------+-------+-------+   +-------+-------+-------+-------+
 *                 |       |       |       |       |   |       |       |       |       |
 *                 `-------+-------+-------+-------+   +-------+-------+-------+-------'
 *                                 |       |       |   |       |       |
 *                                 `----------------   ----------------'
 */
  [_SPACEFN] =  LAYOUT(
    _______,_______,_______,_______,_______,_______,    _______,_______,_______,_______,_______,_______,
    _______,________________SPACEFN_L1_________________,________________SPACEFN_R1________________________,_______,
    _______,________________SPACEFN_L2_________________,________________SPACEFN_R2________________________,_______,
    _______,________________SPACEFN_L3_________________,________________SPACEFN_R3________________________,_______,
    _______,_______,_______,_______,_______,_______,    _______,_______,_______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,    _______,_______,_______,_______,_______,_______
  ),

/* Adjust (Lower + Raise)
 * ,------------------------------------------------   ------------------------------------------------.
 * |  F12  |  F1   |  F2   |  F3   |  F4   |  F5   |   |  F6   |  F7   |  F8   |  F9   |  F10  |  F11  |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       | Reset |RGB_TOG|RGB_MOD|Hue Dwn|Hue Up |   |Sat Dwn|Sat Up |Val Dwn|Val Up |       |Delete |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |Aud on |Aud Off|AG_NORM|   |AG_SWAP|       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * `-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 *                 |       |       |                                   |       |       |
 *                 `-------+-------'                                   `-------+-------'
 *                 +-------+-------+-------+-------+   +-------+-------+-------+-------+
 *                 |       |       |       |       |   |       |       |       |       |
 *                 `-------+-------+-------+-------+   +-------+-------+-------+-------'
 *                                 |       |       |   |       |       |
 *                                 `----------------   ----------------'
 */
  [_ADJUST] =  LAYOUT(
    KC_F12, _________________FUNC_LEFT_________________,_________________FUNC_RIGHT________________, KC_F11,
    _______,_________________ADJUST_L1_________________,_________________ADJUST_R1_________________,KC_DEL,
    _______,_________________ADJUST_L2_________________,_________________ADJUST_R2_________________,_______,
    _______,_________________ADJUST_L3_________________,_________________ADJUST_R3_________________,_______,
    _______,_______,_______,_______,_______,_______,    _______,_______,_______,_______,_______,_______,
    _______,_______,_______,_______,_______,_______,    _______,_______,_______,_______,_______,_______
  )

/* Template
 * ,------------------------------------------------   ------------------------------------------------.
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |   |       |       |       |       |       |       |
 * `-------+-------+-------+-------+-------+-------+   +-------+-------+-------+-------+-------+-------|
 *                 |       |       |                                   |       |       |
 *                 `-------+-------'                                   `-------+-------'
 *                 +-------+-------+-------+-------+   +-------+-------+-------+-------+
 *                 |       |       |       |       |   |       |       |       |       |
 *                 `-------+-------+-------+-------+   +-------+-------+-------+-------'
 *                                 |       |       |   |       |       |
 *                                 `----------------   ----------------'
 */
};

#ifdef AUDIO_ENABLE
float tone_qwerty[][2]     = SONG(QWERTY_SOUND);
float tone_dvorak[][2]     = SONG(DVORAK_SOUND);
float tone_colemak[][2]    = SONG(COLEMAK_SOUND);
#endif

const uint16_t PROGMEM fn_actions[] = {
    [0]  = ACTION_LAYER_TAP_KEY(_SPACEFN, KC_SPC),
};

void persistent_default_layer_set(uint16_t default_layer) {
  eeconfig_update_default_layer(default_layer);
  default_layer_set(default_layer);
}

//static uint16_t special_timers[LONGPRESS_COUNT] = {0xFFFF,0xFFFF,0xFFFF,0xFFFF};
//static bool special_key_states[LONGPRESS_COUNT] = {0,0,0,0};

//static uint16_t shift_timer;
//static uint16_t num_timer;
//static uint16_t mouse_timer;

//static bool shift_singular_key = false;
//static bool number_singular_key = false;
//static bool mouse_singular_key = false;

static bool shift_held = false;
static bool shift_suspended = false;
report_mouse_t currentReport = {};

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  switch (keycode) {
      //mouse buttons, for 1-3, to update the mouse report:
    case MS_BTN1:
      currentReport = pointing_device_get_report();
      if (record->event.pressed) {
              if (shift_held && shift_suspended){
                      register_code(KC_LSFT);
                      shift_suspended = false;
              }
              //update mouse report here
              currentReport.buttons |= MOUSE_BTN1; //MOUSE_BTN1 is a const defined in report.h
      } else {
              //update mouse report here
              currentReport.buttons &= ~MOUSE_BTN1;
      }
      pointing_device_set_report(currentReport);
      break;
    case MS_BTN2:
      currentReport = pointing_device_get_report();
      if (record->event.pressed) {
              if (shift_held && shift_suspended){
                      register_code(KC_LSFT);
                      shift_suspended = false;
              }
              //update mouse report here
              currentReport.buttons |= MOUSE_BTN2; //MOUSE_BTN2 is a const defined in report.h
      } else {
              //update mouse report here
      }
      pointing_device_set_report(currentReport);
      break;
      //there is a case for button 3, but that's handled in dichotemy.c, and this is being
      //disabled to avoid any conflict.
    case MS_BTN3:
      currentReport = pointing_device_get_report();
      if (record->event.pressed) {
              if (shift_held && shift_suspended){
                      register_code(KC_LSFT);
                      shift_suspended = false;
              }
              //update mouse report here
              currentReport.buttons |= MOUSE_BTN3; //MOUSE_BTN2 is a const defined in report.h
      } else {
              //update mouse report here
      }
      pointing_device_set_report(currentReport);
		break;
  }
  return true;
}
